<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet State Monitor</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background-color: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #000;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #00ff00;
        }
        .header {
            text-align: center;
            color: #00ffff;
            margin-bottom: 20px;
        }
        .state-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .state-box {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 5px;
        }
        .state-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .state-value {
            color: #00ff00;
            margin: 5px 0;
        }
        .state-value.error {
            color: #ff0000;
        }
        .state-value.warning {
            color: #ffa500;
        }
        .log-container {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-left: 3px solid #00ff00;
            font-size: 12px;
        }
        .log-entry.error {
            border-left-color: #ff0000;
            color: #ff6666;
        }
        .log-entry.warning {
            border-left-color: #ffa500;
            color: #ffcc66;
        }
        .log-entry.info {
            border-left-color: #00ffff;
            color: #66ffff;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
        }
        button:hover {
            background: #00ff00;
            color: #000;
        }
        .timestamp {
            color: #666;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç WALLET STATE MONITOR</h1>
            <p>Real-time monitoring of wallet connection and user state</p>
        </div>

        <div class="controls">
            <button onclick="startMonitoring()">Start Monitoring</button>
            <button onclick="stopMonitoring()">Stop Monitoring</button>
            <button onclick="clearLogs()">Clear Logs</button>
            <button onclick="exportLogs()">Export Logs</button>
        </div>

        <div class="state-display">
            <div class="state-box">
                <div class="state-title">WALLET STATE</div>
                <div class="state-value" id="isConnected">Connected: <span>Unknown</span></div>
                <div class="state-value" id="walletAddress">Address: <span>None</span></div>
                <div class="state-value" id="isConnecting">Connecting: <span>Unknown</span></div>
                <div class="state-value" id="chainId">Chain ID: <span>Unknown</span></div>
            </div>
            
            <div class="state-box">
                <div class="state-title">USER STATE</div>
                <div class="state-value" id="hasUser">Has User: <span>Unknown</span></div>
                <div class="state-value" id="username">Username: <span>None</span></div>
                <div class="state-value" id="isNewUser">Is New User: <span>Unknown</span></div>
                <div class="state-value" id="userError">Error: <span>None</span></div>
            </div>
        </div>

        <div class="state-box">
            <div class="state-title">MONITORING LOG</div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script>
        let monitoringInterval;
        let logs = [];
        let lastState = {};

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp,
                message,
                type
            };
            logs.push(logEntry);
            
            const logContainer = document.getElementById('logContainer');
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${type}`;
            logElement.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 1000 log entries
            if (logs.length > 1000) {
                logs = logs.slice(-1000);
                const logElements = logContainer.children;
                if (logElements.length > 1000) {
                    logContainer.removeChild(logElements[0]);
                }
            }
        }

        function updateStateDisplay(state) {
            // Update wallet state
            document.getElementById('isConnected').innerHTML = `Connected: <span>${state.isConnected || 'false'}</span>`;
            document.getElementById('walletAddress').innerHTML = `Address: <span>${state.address || 'None'}</span>`;
            document.getElementById('isConnecting').innerHTML = `Connecting: <span>${state.isConnecting || 'false'}</span>`;
            document.getElementById('chainId').innerHTML = `Chain ID: <span>${state.chainId || 'Unknown'}</span>`;
            
            // Update user state
            const hasUser = !!state.user;
            document.getElementById('hasUser').innerHTML = `Has User: <span class="${hasUser ? '' : 'error'}">${hasUser}</span>`;
            document.getElementById('username').innerHTML = `Username: <span>${state.user?.username || 'None'}</span>`;
            document.getElementById('isNewUser').innerHTML = `Is New User: <span>${state.isNewUser || 'false'}</span>`;
            
            const errorElement = document.getElementById('userError');
            if (state.error) {
                errorElement.innerHTML = `Error: <span class="error">${state.error}</span>`;
                errorElement.className = 'state-value error';
            } else {
                errorElement.innerHTML = `Error: <span>None</span>`;
                errorElement.className = 'state-value';
            }
        }

        function detectStateChanges(newState) {
            const changes = [];
            
            // Check for connection changes
            if (lastState.isConnected !== newState.isConnected) {
                changes.push(`Connection: ${lastState.isConnected} ‚Üí ${newState.isConnected}`);
            }
            
            if (lastState.address !== newState.address) {
                changes.push(`Address: ${lastState.address || 'None'} ‚Üí ${newState.address || 'None'}`);
            }
            
            // Check for user changes
            const hadUser = !!lastState.user;
            const hasUser = !!newState.user;
            
            if (hadUser !== hasUser) {
                changes.push(`User State: ${hadUser} ‚Üí ${hasUser}`);
            }
            
            if (lastState.user?.username !== newState.user?.username) {
                changes.push(`Username: ${lastState.user?.username || 'None'} ‚Üí ${newState.user?.username || 'None'}`);
            }
            
            if (lastState.error !== newState.error) {
                changes.push(`Error: ${lastState.error || 'None'} ‚Üí ${newState.error || 'None'}`);
            }
            
            // Log changes
            changes.forEach(change => {
                log(`üîÑ STATE CHANGE: ${change}`, 'info');
            });
            
            // Detect problematic patterns
            if (newState.isConnected && newState.address && !newState.user && !newState.error) {
                log('‚ö†Ô∏è PROBLEM DETECTED: Wallet connected but no user found and no error', 'warning');
            }
            
            if (newState.isConnected && !newState.address) {
                log('‚ö†Ô∏è PROBLEM DETECTED: Wallet shows connected but no address', 'warning');
            }
            
            if (newState.user && !newState.isConnected) {
                log('‚ö†Ô∏è PROBLEM DETECTED: User exists but wallet not connected', 'warning');
            }
            
            lastState = { ...newState };
        }

        function checkWalletState() {
            try {
                // Try to access the main app's state
                if (window.parent && window.parent !== window) {
                    // Request state from parent window
                    window.parent.postMessage({
                        type: 'REQUEST_WALLET_STATE'
                    }, '*');
                } else {
                    // Try to access global state if available
                    if (window.walletState) {
                        const state = window.walletState;
                        updateStateDisplay(state);
                        detectStateChanges(state);
                    } else {
                        log('‚ö†Ô∏è No wallet state available', 'warning');
                    }
                }
            } catch (error) {
                log(`‚ùå Error checking wallet state: ${error.message}`, 'error');
            }
        }

        function startMonitoring() {
            log('üöÄ Starting wallet state monitoring...', 'info');
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            // Check state every 500ms
            monitoringInterval = setInterval(checkWalletState, 500);
            
            // Initial check
            checkWalletState();
        }

        function stopMonitoring() {
            log('‚èπÔ∏è Stopping wallet state monitoring...', 'info');
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }

        function clearLogs() {
            logs = [];
            document.getElementById('logContainer').innerHTML = '';
            log('üßπ Logs cleared', 'info');
        }

        function exportLogs() {
            const logData = logs.map(log => `[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}`).join('\n');
            const blob = new Blob([logData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wallet-state-logs-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            log('üìÅ Logs exported', 'info');
        }

        // Listen for messages from parent window
        window.addEventListener('message', (event) => {
            if (event.data.type === 'WALLET_STATE_UPDATE') {
                const state = event.data.state;
                updateStateDisplay(state);
                detectStateChanges(state);
            }
        });

        // Auto-start monitoring
        window.addEventListener('load', () => {
            log('üéØ Wallet State Monitor loaded', 'info');
            startMonitoring();
        });

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            stopMonitoring();
        });
    </script>
</body>
</html>